\usepackage{fontspec}
\usepackage{xunicode}
\usepackage{xltxtra}
\usepackage[english]{babel}

%\usepackage[frenchb]{babel}
%\frenchbsetup{StandardLists=true}
%\setromanfont[Mapping=tex-text]{FreeSerif}
%\setsansfont[Mapping=tex-text]{FreeSans}
\setmonofont[Mapping=tex-text]{DejaVu Sans Mono}
% urls %

\usepackage{url}
% href %
\usepackage{hyperref}

\hypersetup{
	linktocpage  = true, %page number is the link (not title)
	colorlinks   = true, %Colours links instead of ugly boxes
	urlcolor     = darkblue, %Colour for external hyperlinks
	linkcolor    = darkblue, %Colour of internal links
	citecolor    = darkblue   %Colour of citations
}
% enumitem %
\usepackage{enumitem}
\setlist{leftmargin=1cm}
\setlist[itemize,1]{label={$\bullet$}}
\usepackage{nomencl}
\usepackage[subfigure]{tocloft}
\usepackage{xstring}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{thmtools}
\usepackage{subfigure}

\def\subfigureautorefname{Subfigure}
% fix vspace between paragraphs %
\usepackage{parskip}
% subsubsubsections + paragraph style %

\usepackage{titlesec}
\titleclass{\subsubsubsection}{straight}[\subsection]

\newcounter{subsubsubsection}
\renewcommand\thesubsubsubsection{\thesubsubsection.\arabic{subsubsubsection}}
\renewcommand\theparagraph{\thesubsubsubsection.\arabic{paragraph}}

\titleformat{\subsubsubsection}
  {\normalfont\normalsize\bfseries}{\thesubsubsubsection}{1em}{}
\titlespacing*{\subsubsubsection}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\def\subsubsubsectionautorefname{Subsubsubsection}


\titleformat{\paragraph}
  {\normalfont\normalsize\bfseries}{\theparagraph}{1em}{}
\titlespacing*{\paragraph}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\titleformat{\subparagraph}
  {\normalfont\normalsize\bfseries}{\thesubparagraph}{1em}{}
\titlespacing*{\subparagraph}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\def\toclevel@subsubsubsection{4}
\def\toclevel@paragraph{5}
\def\toclevel@subparagraph{6}
\def\l@subsubsubsection{\@dottedtocline{4}{7em}{4em}}
\def\l@paragraph{\@dottedtocline{5}{10em}{5em}}
\def\l@subparagraph{\@dottedtocline{6}{14em}{6em}}

\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{4}

% section no num %
\newcommand\sectionnonum[1]{
	\newpage\cleardoublepage\phantomsection
	\addcontentsline{toc}{section}{#1}
	\section*{#1}
	\sectionmark{#1}
}

% dedication %

\newcommand\dedication[3]{
	\newpage\cleardoublepage\phantomsection
	\thispagestyle{empty}
	\begin{flushright}
	\null\vspace{\stretch{#1}}
	\textit{\color[HTML]{b0b0b0} #3}
	\vspace{\stretch{#2}}\null
	\end{flushright}
}
% screenshot %
\usepackage{graphicx}
\newcommand\screenshot[3]{
	\begin{figure}[H]
		\centering
		\includegraphics[width=\textwidth]{{{#1}}}
		\caption{#2}
		\label{fig:#3}
	\end{figure}
}
% define colors %
\usepackage[table]{xcolor}
\definecolor{lightgray}{rgb}{.9,.9,.9}
\definecolor{darkgray}{rgb}{.4,.4,.4}
\definecolor{purple}{rgb}{0.65, 0.12, 0.82}
\definecolor{darkblue}{rgb}{0.02, 0.17, 0.40}

\definecolor{monokaibg}{HTML}{272822}
\definecolor{monokaifr}{HTML}{303030}
\definecolor{monokaitxt}{HTML}{F8F8F2}
%\definecolor{monokai_error}{HTML}{960050}
%\definecolor{monokai_comment}{HTML}{75715e}
%\definecolor{monokai_keyword}{HTML}{66d9ef}
%\definecolor{monokai_keyword.namespace}{HTML}{f92672}
%\definecolor{monokai_operator}{HTML}{f92672}
%\definecolor{monokai_punctuation}{HTML}{f8f8f2}
%\definecolor{monokai_name}{HTML}{f8f8f2}
%\definecolor{monokai_name.attribute}{HTML}{a6e22e}
%\definecolor{monokai_name.class}{HTML}{a6e22e}
%\definecolor{monokai_name.constant}{HTML}{66d9ef}
%\definecolor{monokai_name.decorator}{HTML}{a6e22e}
%\definecolor{monokai_name.exception}{HTML}{a6e22e}
%\definecolor{monokai_name.function}{HTML}{a6e22e}
%\definecolor{monokai_name.other}{HTML}{a6e22e}
%\definecolor{monokai_name.tag}{HTML}{f92672}
%\definecolor{monokai_number}{HTML}{ae81ff}
%\definecolor{monokai_literal}{HTML}{ae81ff}
%\definecolor{monokai_literal.date}{HTML}{e6db74}
%\definecolor{monokai_string}{HTML}{e6db74}
%\definecolor{monokai_string.escape}{HTML}{ae81ff}
\usepackage{listings}
% define JavaScript highlighting %
\lstdefinelanguage{JavaScript}{
	keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
	ndkeywords={class, export, boolean, throw, implements, import, this},
	ndkeywordstyle=\color{darkgray}\bfseries,
	sensitive=false,
	comment=[l]{//},
	morecomment=[s]{/*}{*/},
	morestring=[b]',
	morestring=[b]"
}
% define PHP highlighting %
%\lstdefinestyle{PHP}{
%	language= php,
%	backgroundcolor=\color{lightgray},
%	belowcaptionskip=1\baselineskip,
%	breaklines=true,
%	captionpos=b,
%	xleftmargin=\parindent,
%	numbers=left,
%	numbersep=5pt,
%	numberstyle=\tiny\color{darkgray},
%	showstringspaces=false,
%	basicstyle=\footnotesize\ttfamily,
%	keywordstyle=\bfseries\color{green!40!black},
%	commentstyle=\itshape\color{purple!40!black},
%	identifierstyle=\color{blue},
%	stringstyle=\color{orange},
%	emph            =[1]{php},
%	emphstyle       =[1]\color{black},
%	emph            =[2]{if,and,or,else},
%	emphstyle       =[2]\color{yellow},
%	numbers=left,
%	numberstyle=\footnotesize,
%	numbersep=9pt, 
%}
\renewcommand\lstlistingname{Source code}
\renewcommand\lstlistlistingname{List of source code}
\def\lstlistingautorefname{Src.}
\newcommand\makesrc[0]{
	\newpage\cleardoublepage\phantomsection
	\addcontentsline{toc}{section}{Source code}
	\lstlistoflistings
}
% general style for listing captions
\usepackage{caption}
\usepackage{calc}
\DeclareCaptionFont{white}{\color{white}}
\DeclareCaptionFormat{listing}{\noindent\colorbox{gray}{\parbox{\textwidth- 2 \fboxsep}{#1#2#3}}}
\captionsetup[lstlisting]{format=listing,labelfont=white,textfont=white}

\lstset{
	backgroundcolor=\color{lightgray},
	extendedchars=true,
	showstringspaces=false,
	showspaces=false,
	numbers=left,
	numberstyle=\footnotesize\color{darkgray}\textbf,
	numbersep=9pt,
	tabsize=2,
	breaklines=true,
	showtabs=false,
	basicstyle=\footnotesize\ttfamily,
	keywordstyle=\bfseries\color{green!40!black},
	commentstyle=\itshape\color{purple!40!black},
	identifierstyle=\color{blue},
	stringstyle=\color{orange},
	belowcaptionskip=0pt,
	aboveskip=0pt
}
% pseudo code%
\usepackage[algosection]{algorithm2e}

\addto\captionsenglish{
  \renewcommand{\listalgorithmcfname}{List of Algorithms}
  \def\algorithmautorefname{Algorithm}
}
\addto\captionsfrench{
  \renewcommand{\listalgorithmcfname}{Table des algorithmes}
  \def\algorithmautorefname{Algorithme}
}

\DeclareCaptionType[within=none]{algobject}
\DeclareCaptionFormat{algobjectformat}{}
\captionsetup[algobject]{format=algobjectformat, labelformat=empty}

\addto\captionsenglish{
  \renewcommand{\listalgobjectname}{List of Algorithms}
  \renewcommand{\algobjectname}{Algorithm}
}
\addto\captionsfrench{
  \renewcommand{\listalgobjectname}{Table des algorithmes}
  \renewcommand{\algobjectname}{Algorithme}
}

\numberwithin{algobject}{section}

\newcommand\makealg[0]{
  \newpage\cleardoublepage\phantomsection
  \addcontentsline{toc}{section}{\listalgobjectname}
  \listofalgobjects
}


\newcommand\inputalgorithm[4][]{%
  \begin{algobject}[#1]
  \caption{#2}
  \label{#3}
  \begin{algorithm}[#1]
  \caption{#2}
  \input{#4}
  \end{algorithm}
  \end{algobject}
}

%\newcommand\makealg[0]{
%	\newpage\cleardoublepage\phantomsection
%	\addcontentsline{toc}{chapter}{\listalgorithmcfname}
%	\listofalgorithms
%}
% use of pdfs %

\usepackage{pdfpages}
% indexing %
\usepackage{makeidx}
%\usepackage{showidx} %to show idx for proofreading
\makeindex

\newcommand\makeind[0]{
	\newpage\cleardoublepage\phantomsection
	\addcontentsline{toc}{section}{Index}
	\printindex
}
% typo convention %
\newcommand\defineconcept[1]{
	\textbf{#1}\index{#1|textbf}
}

\newcommand\concept[1]{
	\textbf{#1}\index{#1}
}

\newcommand\important[1]{
	\textit{#1}
}
% NB %
\newcommand\nb[1]{%
	{\Large{\leafleft}} #1%
}
% biblio %

\bibliographystyle{apalike}

\newcommand\makebib[1]{
	\newpage\cleardoublepage\phantomsection
	\addcontentsline{toc}{section}{\bibname}
	\bibliography{#1}
	\nocite{*}
}
% figures %

\newcommand\makefig[0]{
	\newpage\cleardoublepage\phantomsection
	\addcontentsline{toc}{section}{\listfigurename}
	\listoffigures
}
% partoken %

\newcommand\partoken[0]{\textbf{§}}
% maths %

\addto\captionsfrench{
	\renewcommand\listtheoremname{Table des théorèmes}
}

\newcommand{\theoremname}{Theorem}
\newcommand{\lemmaname}{Lemma}
\newcommand{\conjecturename}{Conjecture}

\addto\captionsfrench{
	\renewcommand{\theoremname}{Théorème}
	\renewcommand{\lemmaname}{Lemme}
	\renewcommand{\conjecturename}{Conjecture}
}

\newtheorem{theorem}{\theoremname}[section]
\newtheorem{lemma}[theorem]{\lemmaname}
\newtheorem{conjecture}[theorem]{\conjecturename}

\newcommand\makethm[0]{
	\newpage\cleardoublepage\phantomsection
	\addcontentsline{toc}{section}{\listtheoremname}
	\listoftheorems
}

\renewcommand{\qedsymbol}{\rule{0.7em}{0.7em}}


\numberwithin{equation}{section}

% we use this for our refernces as well
\AtBeginDocument{\renewcommand{\ref}[1]{\mbox{\autoref{#1}}}}

% redefinition of \equation for convenience
\let\oldequation = \equation
\let\endoldequation = \endequation
\AtBeginDocument{\let\oldlabel = \label}% \AtBeginDocument because hyperref redefines \label
\newcommand{\mynewlabel}[1]{%
  \StrBehind{#1}{eq:}[\Str]% remove "eq:" from labels
  \equations{\Str}\oldlabel{#1}}

\renewenvironment{equation}{%
  \oldequation
  \let\label\mynewlabel
}{\endoldequation}

\newcommand{\listequationsname}{List of Equations}

\addto\captionsfrench{
  \renewcommand{\listequationsname}{Table des équations}
}


\newlistof{equations}{equ}{\listequationsname}
\newcommand{\equations}[1]{%
      \addcontentsline{equ}{equations}{\protect\numberline{\theequation}#1}}


\newcommand\makeequ[0]{
	\newpage\cleardoublepage\phantomsection
	\addcontentsline{toc}{section}{\listequationsname}
	\listofequations
}


\usepackage{array,tabularx}

\newenvironment{conditions}
  {\par\vspace{\abovedisplayskip}\noindent
   \tabularx{\columnwidth}{>{$}l<{$} @{${}={}$} >{\raggedright\arraybackslash}X}}
  {\endtabularx\par\vspace{\belowdisplayskip}}
% header footer %
\usepackage{fancyhdr}
\pagestyle{fancyplain}
\renewcommand{\sectionmark}[1]{\markboth{#1}{}}

\renewcommand{\headrulewidth}{0.5pt}
\fancyhf{}
%\fancyhead[L]{\textbf{\nouppercase\leftmark}}
\fancyhead[R]{\textbf{\nouppercase\leftmark}}

\renewcommand{\footrulewidth}{0.5pt}
\fancyfoot[R]{\textbf\thepage}

\fancypagestyle{plain}{
	\fancyhf{}
	\fancyfoot[R]{\textbf\thepage}
	\renewcommand{\headrulewidth}{0pt}
	\renewcommand{\footrulewidth}{0pt}
}

% removes warnings
\setlength{\headheight}{15pt}
% set lists indent %
\cftsetindents{equations}{1.5em}{2.3em}



% OBSCURE

\renewcommand\listoftheorems[1][]{%
  %% much hacking here to pick up the definition from the class
  %% without oodles of conditionals.
  \bgroup
  \setlisttheoremstyle{#1}%
  \let\listfigurename\listtheoremname
  \def\contentsline##1{%
    \csname thmt@contentsline@##1\endcsname{##1}%
  }%
  \@for\thmt@envname:=\thmt@allenvs\do{%
  \@xa\protected@edef\csname l@\thmt@envname\endcsname{% CHECK: why p@edef?
    \@nx\@dottedtocline{1}{1.2em}{\@nx\thmt@listnumwidth}%
  }%
  }%
  \let\thref@starttoc\@starttoc
  \def\@starttoc##1{\thref@starttoc{loe}}%
  % new hack: to allow multiple calls, we defer the opening of the
  % loe file to AtEndDocument time. This is before the aux file is
  % read back again, that is early enough.
  % TODO: is it? crosscheck include/includeonly!
  \@fileswfalse
  \AtEndDocument{%
    \if@filesw
      \@ifundefined{tf@loe}{%
        \expandafter\newwrite\csname tf@loe\endcsname
        \immediate\openout \csname tf@loe\endcsname \jobname.loe\relax
      }{}%
    \fi
  }%
  %\expandafter
  \listoffigures
  \egroup
}

\renewcommand\thmt@mklistcmd{%
  \@xa\protected@edef\csname l@\thmt@envname\endcsname{% CHECK: why p@edef?
    \@nx\@dottedtocline{1}{1.2em}{\@nx\thmt@listnumwidth}%
  }%
  \ifthmt@isstarred
    \@xa\def\csname ll@\thmt@envname\endcsname{%
      \protect\numberline{\protect\let\protect\autodot\protect\@empty}%
      \thmt@thmname
      \ifx\@empty\thmt@shortoptarg\else\protect\thmtformatoptarg{\thmt@shortoptarg}\fi
    }%
  \else
    \@xa\def\csname ll@\thmt@envname\endcsname{%
      \protect\numberline{\csname the\thmt@envname\endcsname}%
      \thmt@thmname
      \ifx\@empty\thmt@shortoptarg\else\protect\thmtformatoptarg{\thmt@shortoptarg}\fi
    }%
  \fi
  \@xa\gdef\csname thmt@contentsline@\thmt@envname\endcsname{%
    \thmt@contentslineShow% default:show
  }%
}
% maketoc %

\newcommand\maketoc{
	\newpage\cleardoublepage\phantomsection
	\tableofcontents
}
% defbox %
\usepackage{framed}
\newcommand\defbox[1]{
	\begin{center}
	\begin{framed}
	{\textbf{#1}}
	\end{framed}
	\end{center}
}
\newcommand\bgimg[1]{%
\AddToShipoutPicture*{\AtPageCenter{%
\makebox(0 ,0){\includegraphics%
[width =0.9\paperwidth]{#1}}}}}
\newcommand\topimg[1]{
	\includegraphics[width=0.2\paperwidth]{#1}~\\[0.628cm]
}
\newcommand\smallcaps[1]{
	{\fontspec{GFS Didot}\textsc{#1}}
}
\usepackage{datetime}
\newdateformat{dftitle}{
	\monthname, \THEYEAR
}
\usepackage{setspace}
\usepackage{minted}
\usemintedstyle{monokai}
\usepackage{tcolorbox}
\usepackage{etoolbox}
\usepackage{pgfkeys}


\usepackage{lineno}
\def\gobble#1{}
\renewcommand\DeleteFile[1]{}
\usepackage{xparse}
\ExplSyntaxOn
\box_new:N \l_fvrb_box
\tl_new:N \l_fvrb_tl

\RenewDocumentCommand \FancyVerbFormatLine { m }
 {
   \hbox_set:Nn \l_fvrb_box { #1 }
    \dim_compare:nNnTF { \box_wd:N \l_fvrb_box }>{ \linewidth }
      {%box to big 
       \tl_set:Nn \l_fvrb_tl { #1 }
       \fvrb_use_tl:N \l_fvrb_tl
      } 
      {%box fits
       \box_use:N \l_fvrb_box
      }
 }

\cs_new:Npn \fvrb_use_tl:N  #1
 {
  \group_begin:
   \null\hfill\vbox_set:Nn \l_fvrb_box
     {\hsize=\linewidth
      \renewcommand\thelinenumber
           {
             \ifnum\value{linenumber}=1\relax\else\relax
                  %$\rightarrow$
             \fi
           }
      \begin{internallinenumbers}
        \advance\hsize by -2em
        \hspace*{-2em}\tl_use:N #1
      \end{internallinenumbers}
     }
   \box_use:N \l_fvrb_box
  \group_end:
}

\ExplSyntaxOff



%\newtcolorbox[auto counter,number within=section]{codebox}[2][]{%
%colback=\color{monokai_background_color},colframe=\color{HTML}{303030},fonttitle=\bfseries,
%title=Examp.~\thetcbcounter: #2,#1}

\renewcommand{\theFancyVerbLine}{\sffamily
\textcolor[rgb]{0.5,0.5,1.0}{\scriptsize
\oldstylenums{\arabic{FancyVerbLine}}}}

%\let\oldinputminted\inputminted

\pgfkeys{
	/myinputminted/.is family, /myinputminted,
	% Here are the options that a user can pass
	default/.style = {firstline = 1, lastline = 0, mathescape=false, linenos=false, tabsize=4, numbersep=5pt, gobble=1},
	firstline/.estore in = \myinputmintedfirstline,
	lastline/.estore in = \myinputmintedlastline,
  mathescape/.estore in = \myinputmintedmathescape,
  linenos/.estore in = \myinputmintedlinenos,
  tabsize/.estore in = \myinputmintedtabsize,
  numbersep/.estore in = \myinputmintednumbersep,
  gobble/.estore in = \myinputmintedgobble
}

\DeclareCaptionType[within=none]{mintedobject}
\DeclareCaptionFormat{mintedobjectformat}{}
\captionsetup[mintedobject]{format=mintedobjectformat, labelformat=empty}

\addto\captionsenglish{
  \renewcommand{\listmintedobjectname}{List of Source Code}
  \renewcommand{\mintedobjectname}{Source Code}
}
\addto\captionsfrench{
  \renewcommand{\listmintedobjectname}{Table des codes source}
  \renewcommand{\mintedobjectname}{Code source}
}

\numberwithin{mintedobject}{section}

\newcommand\makeminted[0]{
  \newpage\cleardoublepage\phantomsection
  \addcontentsline{toc}{section}{\listmintedobjectname}
  \listofmintedobjects
}

\newcommand\myinputminted[6][]{
  \begin{mintedobject}
  \caption{#4}
  \label{#5}
	\pgfkeys{/myinputminted, default, #1}%
	\begin{tcolorbox}[
	colback=monokaibg,
	colframe=monokaifr,
	coltitle=monokaitxt,
	fonttitle=\sffamily,
	title=\mintedobjectname~\themintedobject : #4,
	arc=0mm
	]
	\inputminted[
	fontsize=\footnotesize,
	firstline=\myinputmintedfirstline,
	lastline=\myinputmintedlastline,
	mathescape=\myinputmintedmathescape,
  tabsize=\myinputmintedtabsize,
  linenos=\myinputmintedlinenos,
  numbersep=\myinputmintednumbersep,
  gobble=#6
	]{#2}{#3}
	\end{tcolorbox}
  \end{mintedobject}
}
\usepackage{lipsum}
\usepackage{marginnote}
\usepackage{todonotes}
\pgfkeys{
	/titlepages/.is family, /titlepages,
	% Here are the options that a user can pass
	default/.style = {
		title = Title,
		author = Author,
		bg = bg,
		logo = logo,
		university = University,
		COURSE = COURSE,
		course = course,
		faculty = Faculty,
		department = Departement,
		academicyear = academicyear
	},
	title/.estore in = \titlepagestitle,
	author/.estore in = \titlepagesauthor,
	bg/.estore in = \titlepagesbg,
	logo/.estore in = \titlepageslogo,
	university/.estore in = \titlepagesuniversity,
	COURSE/.estore in = \titlepagesCOURSE,
	course/.estore in = \titlepagescourse,
	faculty/.estore in = \titlepagesfaculty,
	department/.estore in = \titlepagesdepartment,
	academicyear/.estore in = \titlepagesacademicyear
}


\newcommand{\titlepagesauthorsname}{Authors}

\addto\captionsfrench{
	\renewcommand{\titlepagesauthorsname}{Auteurs}
}

\newcommand\titlepages[1][]{
	\pgfkeys{/titlepages, default, #1}
	\begin{titlepage}
	\pagestyle{empty}
	\begin{center}

	\topimg{\titlepageslogo}
	\smallcaps{\Large \titlepagesuniversity}\\[0.942cm]
	{\large \titlepagesfaculty}\\[0.314cm]
	{\large \titlepagesdepartment}\\[0.314cm]
	\rule{0.314\linewidth}{0.314mm}\\[0.5cm]
	{\smallcaps{\titlepagescourse}}\\[2cm]
	\begin{spacing}{1.5}
	\smallcaps{\LARGE \titlepagestitle}\\[2cm]
	\end{spacing}
	{\titlepagesauthorsname}\\[0.26cm]
	{\large \titlepagesauthor}\\[0.5cm]
	\vfill
	\rule{0.2\linewidth}{0.314mm}\\[0.5cm]
	\today\\[0.3cm]
	\textbf{\titlepagesacademicyear}
	\end{center}
	\end{titlepage}
}
\usepackage{fourier-orns}
\newcommand\trap[1]{%
	{\Large{\bomb}} #1%
}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{mathtools}
\newcommand{\shellcmd}[1]{\indent\indent\texttt{\footnotesize\# #1}}

\newcommand\CXX{C\nolinebreak[4]\hspace{-.05em}\raisebox{.4ex}{\relsize{-3}{\textbf{++}}}}
